pipeline {
    agent any

    environment 
    {
        // Docker hub credentials ID Stored in Jenkins
        DOCKERHUB_CREDENTIALS_ID = 'CWEB2140-01'
        IMAGE_NAME = 'b0ltz205/nodeqr:lts'
        TRIVY_SEVERITY = "HIGH,CRITICAL"
    }

    stages 
    {
        stage('Clone from git')
        {
            steps
            {
                checkout scm
            }
        }

                stage("Check Docker Availability") {
            steps {
                script {
                    echo ' Checking Docker installation...'
                    def dockerCheck = sh(script: 'which docker', returnStatus: true)
                    if (dockerCheck != 0) {
                        error " Docker command not found! Please install Docker or mount /var/run/docker.sock."
                    }
                    sh 'docker --version'
                }
            }
        }
 
        stage("Pull Target Container Image") {
            steps {
                script {
                    echo "⬇️ Pulling image: ${IMAGE_NAME}"
                    sh "docker pull ${IMAGE_NAME}"
                }
            }
        }

 
        stage("Container Vulnerability Scan (Trivy)") {
            steps {
                script {
                    echo " Scanning Docker image ${IMAGE_NAME} for vulnerabilities..."
 
            // Run Trivy scan but don’t stop the pipeline if it fails
            catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                // JSON report
                sh """
                    docker run --rm -v \$(pwd):/workspace aquasec/trivy:latest image \
                    --exit-code 0 \
                    --format json \
                    --output /workspace/trivy-report.json \
                    --severity ${TRIVY_SEVERITY} \
                    ${IMAGE_NAME}
                """

                // HTML report
                sh """
                    docker run --rm -v \$(pwd):/workspace aquasec/trivy:latest image \
                    --exit-code 0 \
                    --format template \
                    --template "@/contrib/html.tpl" \
                    --output /workspace/trivy-report.html \
                    ${IMAGE_NAME}
                """
            }
        }
    }
            post {
                always {
                    echo "Archiving Trivy reports..."
                    archiveArtifacts artifacts: 'trivy-report.json,trivy-report.html', allowEmptyArchive: true
                }
            }
        }
 
        stage("Summarize Vulnerabilities") {
            steps {
                catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                script {
                    if (fileExists('trivy-report.json')) {
                        def reportContent = readFile('trivy-report.json')
                        def reportJson = new groovy.json.JsonSlurper().parseText(reportContent)
 
                        def highCount = 0
                        def criticalCount = 0
 
                        reportJson.Results.each { result ->
                            result.Vulnerabilities?.each { vuln ->
                                switch (vuln.Severity) {
                                    case 'HIGH': highCount++; break
                                    case 'CRITICAL': criticalCount++; break
                                }
                            }
                        }
 
                        echo "HIGH vulnerabilities: ${highCount}"
                        echo "CRITICAL vulnerabilities: ${criticalCount}"
 
                        if (criticalCount > 0) {
                            error "Critical vulnerabilities detected: ${criticalCount}"
                        }
                    } else {
                        echo "Trivy JSON report not found!"
                    }
                }
            }
        }
    }




            stage("DAST Scan with OWASP ZAP") {
            steps {
                script {
                    echo ' Running OWASP ZAP baseline scan...'
 
                    // Run ZAP baseline scan and capture exit code
                    def exitCode = sh(script: '''
                        docker run --rm --user root --network host -v $(pwd):/zap/wrk:rw \
                        -t ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
                        -t http://172.237.145.44 \
                        -r zap_report.html -J zap_report.json
                    ''', returnStatus: true)
 
                    echo "ZAP scan finished with exit code: ${exitCode}"
 
                    // Parse ZAP JSON report safely
                    if (fileExists('zap_report.json')) {
                        def zapContent = readFile('zap_report.json')
                        def zapJson = new groovy.json.JsonSlurper().parseText(zapContent)
 
                        def highCount = 0
                        def mediumCount = 0
                        def lowCount = 0
 
                        zapJson.site.each { site ->
                            site.alerts.each { alert ->
                                switch (alert.risk) {
                                    case 'High': highCount++; break
                                    case 'Medium': mediumCount++; break
                                    case 'Low': lowCount++; break
                                }
                            }
                        }
 
                        echo "High severity issues: ${highCount}"
                        echo "Medium severity issues: ${mediumCount}"
                        echo "Low severity issues: ${lowCount}"
                    } else {
                        echo "ZAP JSON report not found, continuing build..."
                    }
                }
            }
            post {
                always {
                    echo 'Archiving ZAP scan reports...'
                    archiveArtifacts artifacts: 'zap_report.html,zap_report.json', allowEmptyArchive: true
                }
            }
        }

       stage("SCA-SAST-SNYK-TEST")
         {
              agent any
              steps 
              {
                   script
                   {
                        snykSecurity(
                             snykInstallation:'snyk-installations',
                             snykTokenId:'Snyk-Token',
                             severity:'critical',
                             failOnIssues: false
                        )
                   }
            }
}

    stage('SonarQube Analysis') {
            agent {
                label 'CWEB-2140-AppServer'
            }
            steps {
                script {
                    def scannerHome = tool 'SonarQube-Scanner'
                    withSonarQubeEnv('SonarQube-Scanner') {
                        sh "${scannerHome}/bin/sonar-scanner \
                            -Dsonar.projectKey=chatapp \
                            -Dsonar.sources=."
                    }
                }
            }
        }

        stage('BUILD-AND-TAG')
        {
            agent{label 'CWEB-2140-AppServer'}
            steps
            {
                script
                {
                    // Build docker image using jenkins docker pipeline API
                    echo "Building Docker image ${IMAGE_NAME}"
                    app = docker.build ("${IMAGE_NAME}")
                    app.tag("lts")
                }
            }
        }

        stage('PUSH-TO-DOCKER-HUB')
        {
            agent{label 'CWEB-2140-AppServer'}
            steps
            {
                script
                {
                    // Build docker image using jenkins docker pipeline API
                    echo "Pushing image ${IMAGE_NAME}:latest to Docker Hub..."
                    docker.withRegistry('https://registry.hub.docker.com', "${DOCKERHUB_CREDENTIALS_ID}")
                    {
                        app.push("lts")
                    }
                }
            }
        }

        stage('DEPLOY-TO-PRODUCTION')
        {
            agent{label 'CWEB-2140-AppServer'}
            steps
            {
                echo "Starting deployment using docker-compose..."
                
                    script
                    {
                        dir("${env.WORKSPACE}")
                        {
                            sh'''
                            docker-compose down
                            docker-compose up -d
                            docker ps
                            '''
                        }
                    }
                echo "Deployment completed successfully."
            }
        }

        stage('Check')
        {
            agent{label 'CWEB-2140-AppServer'}
            steps
            {
                sh 'docker-compose logs'

            }
        }
    }
}
